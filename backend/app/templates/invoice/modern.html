<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice - {{ invoice_number }}</title>
  <!-- External CSS files will be loaded by PDF service -->
</head>
<body>
  <div class="document-container">
    <!-- Header Section -->
    <div class="document-header">
      <div class="company-info">
        {% if company.logo %}
          <div class="company-logo">
            <img src="{{ company.logo }}" alt="{{ company.name }} Logo">
          </div>
        {% endif %}
        <div class="company-name">{{ company.name }}</div>
        <div class="company-details">
          {{ company.address }}<br>
          {{ company.city }}, {{ company.state }} {{ company.zip }}<br>
          {{ company.phone }}<br>
          {{ company.email }}
        </div>
      </div>

      <div class="document-meta">
        <h1 class="document-title">INVOICE</h1>
        <div class="document-details">
          <div class="detail-row">
            <span class="detail-label">Invoice #:</span>
            <span class="detail-value">{{ invoice_number }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Date:</span>
            <span class="detail-value">{{ date_of_issue }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Due Date:</span>
            <span class="detail-value">{{ date_due }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Billing Information -->
    <div class="billing-section">
      <div class="bill-to">
        <div class="section-title">Bill To</div>
        <div class="client-name">{{ client.name }}</div>
        <div class="client-details">
          {% if client.phone %}{{ client.phone }}<br>{% endif %}
          {% if client.email %}{{ client.email }}<br>{% endif %}
          {% if client.address %}{{ client.address }}{% endif %}
        </div>
        {% if client.type == 'company' %}
          <span class="client-type-badge">Company Client</span>
        {% endif %}
      </div>

      <div class="bill-from">
        <div class="section-title">From</div>
        <div class="client-name">{{ company.name }}</div>
        <div class="client-details">
          {{ company.address }}<br>
          {{ company.city }}, {{ company.state }} {{ company.zip }}<br>
          {{ company.phone }}<br>
          {{ company.email }}
        </div>
      </div>
    </div>

    <!-- Top Note -->
    {% if top_note %}
      <div class="top-note">
        <p>{{ top_note }}</p>
      </div>
    {% endif %}

    <!-- Amount Due Banner -->
    <div class="amount-due-banner {% if total <= 0 %}paid{% endif %}">
      <p class="amount-due-text">
        {% if total <= 0 %}
          PAID IN FULL
        {% else %}
          {{ total|format_currency }} USD due {{ date_due }}
        {% endif %}
      </p>
    </div>

    <!-- Invoice Items by Section -->
    {% for section in serviceSections %}
      <div class="items-section">
        {% if serviceSections|length > 1 %}
          <div class="section-header">{{ section.title }}</div>
        {% endif %}
        
        <table class="items-table">
          <thead>
            <tr>
              <th style="width: 45%;">Item</th>
              <th class="text-center" style="width: 10%;">Qty</th>
              <th class="text-center" style="width: 10%;">Unit</th>
              <th class="text-right" style="width: 15%;">Price</th>
              <th class="text-right" style="width: 20%;">Total</th>
            </tr>
          </thead>
          <tbody>
            {% for item in section.line_items %}
              <tr class="{% if item.hide_price %}hidden-price-item{% endif %}">
                <td>
                  <div class="item-name">{{ item.name }}</div>
                  {% if item.dec %}
                    <div class="item-description">{{ item.dec|replace('\n', '<br>')|safe }}</div>
                  {% endif %}
                  {% if item.hide_price %}
                    <span class="hidden-price-badge">Price Hidden</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if not item.hide_price %}{{ item.qty }}{% else %}—{% endif %}
                </td>
                <td class="text-center">
                  {% if not item.hide_price %}{{ item.unit }}{% else %}—{% endif %}
                </td>
                <td class="text-right">
                  {% if not item.hide_price %}{{ item.price|format_currency }}{% else %}—{% endif %}
                </td>
                <td class="text-right">
                  {% if not item.hide_price %}{{ (item.qty * item.price)|format_currency }}{% else %}—{% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if section.showSubtotal and section.line_items|length > 1 %}
          <div class="section-subtotal">
            Section Subtotal: {{ section.subtotal|format_currency }}
          </div>
        {% endif %}
      </div>
    {% endfor %}

    <!-- Payment History -->
    {% if payments and payments|length > 0 %}
      <div class="payments-section">
        <div class="section-header">Payment History</div>
        <table class="payments-table">
          <thead>
            <tr>
              <th style="width: 30%;">Date</th>
              <th style="width: 25%;">Amount</th>
              <th style="width: 45%;">Notes</th>
            </tr>
          </thead>
          <tbody>
            {% for payment in payments %}
              <tr>
                <td>
                  {% if payment.date %}
                    {{ payment.date }}
                  {% else %}
                    <span class="no-date">No date specified</span>
                  {% endif %}
                </td>
                <td class="payment-amount">-{{ payment.amount|format_currency }}</td>
                <td>{{ payment.notes or '—' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

    <!-- Totals Section -->
    <div class="totals-section">
      <div class="totals-table">
        <div class="totals-row subtotal">
          <span>Subtotal</span>
          <span>{{ subtotal_total|format_currency }}</span>
        </div>

        {% if tax_calculated and tax_calculated > 0 %}
          <div class="totals-row tax">
            <span>
              Tax
              {% if tax_type == "percentage" %}
                ({{ tax_rate }}%)
              {% endif %}
            </span>
            <span>{{ tax_calculated|format_currency }}</span>
          </div>
        {% endif %}

        <div class="totals-row total">
          <span>
            {% if tax_calculated and tax_calculated > 0 %}Total with Tax{% else %}Total{% endif %}
          </span>
          <span>{{ total_with_tax|format_currency }}</span>
        </div>

        {% if payments and payments|length > 0 %}
          <div class="totals-row paid">
            <span>Total Paid</span>
            <span>-{{ payments|sum(attribute='amount')|format_currency }}</span>
          </div>

          <div class="totals-row due {% if total <= 0 %}paid-in-full{% endif %}">
            <span>
              {% if total <= 0 %}Paid in Full{% else %}Amount Due{% endif %}
            </span>
            <span>
              {% if total <= 0 %}✓{% else %}{{ total|format_currency }}{% endif %}
            </span>
          </div>
        {% else %}
          <div class="totals-row due">
            <span>Amount Due</span>
            <span>{{ total|format_currency }}</span>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Footer Section -->
    <div class="footer-section">
      {% if bottom_note %}
        <div class="bottom-note">
          <h4>Notes</h4>
          <p>{{ bottom_note|replace('\n', '<br>')|safe }}</p>
        </div>
      {% endif %}

      {% if disclaimer %}
        <div class="disclaimer">
          <h4>Disclaimer</h4>
          <p>{{ disclaimer|replace('\n', '<br>')|safe }}</p>
        </div>
      {% endif %}
    </div>
  </div>
</body>
</html>