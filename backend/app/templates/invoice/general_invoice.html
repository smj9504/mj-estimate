<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoice</title>
  <style>
    /* PDF Header/Footer Styling */
    @page {
      margin: 95px 25px 75px 25px;

      @top-right {
        content: "{{ client_address_line1 }}" "\A" "{{ client_address_line2 }}";
        font-size: 10px;
        color: #333;
        text-align: right;
        white-space: pre-line;
      }

      @bottom-left {
        content: "Page " counter(page) " of " counter(pages);
        font-size: 10px;
        color: #666;
      }

      @bottom-right {
        content: "Invoice #{{ invoice_number }}";
        font-size: 10px;
        color: #666;
        text-align: right;
      }
    }

    @page :first {
      margin-top: 25px;

      @top-right {
        content: none;
      }
    }

    body {
      font-family: Arial, sans-serif;
      font-size: 12px;
      color: #000;
      margin: 25px;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    .company-logo {
      text-align: right;
    }
    .logo {
      max-width: 100px;
      max-height: 60px;
      width: auto;
      height: auto;
      object-fit: contain;
    }
    .invoice-meta {
      line-height: 1.3;
      margin-top: 0;
      margin-bottom: 0;
      font-size: 13px;
    }
    .invoice-meta h1 {
      margin-top: 0;
      margin-bottom: 5px;
      font-size: 24px;
    }
    .invoice-meta p {
      margin: 2px 0;
    }
    .address-section {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .address-section p {
      margin: 2px 0;
    }
    .company-info {
      width: 45%;
      font-size: 13px;
    }
    .client-insurance-container {
      width: 45%;
      text-align: left;
      display: flex;
      gap: 30px;
    }
    .client-info {
      font-size: 13px;
      flex: 1;
      min-width: 0;
    }
    .insurance-info {
      font-size: 13px;
      flex: 1;
      min-width: 0;
    }
    .amount-due {
      margin: 30px 0px 20px 0px;
      font-weight: bold;
    }
    .amount-due h3 {
      font-weight: bold;
      font-size: 18px;
      margin: 0;
    }
    .line-header {
      font-weight: bold;
      border-bottom: 1px solid #ccc;
      margin-top: 8px;
      padding-bottom: 3px;
      display: flex;
    }
    .line-row {
      display: flex;
      padding: 4px 0;
      font-size: 13px;
    }
    .line-header + .line-row {
      padding-top: 6px;
    }
    .col-item { width: 55%; }
    .col-qty  { width: 10%; text-align: right; }
    .col-unit  { width: 5%; text-align: right; }
    .col-price { width: 15%; text-align: right; }
    .col-total { width: 15%; text-align: right; }
    .col-desc { width: 80%; }
    .col-desc {
      font-style: italic;
      font-size: 13px;
      color: #555;
      margin-left: 30px;
      margin-top: 2px;
    }
    .section-title {
      margin-top: 20px;
      margin-bottom: 4px;
      font-weight: bold;
      font-size: 14px;
      color: #000;
      border-bottom: 1px solid #333;
      padding-bottom: 4px;
    }
    .subtotal {
      font-size: 13px;
      text-align: right;
      font-weight: normal;
      padding-top: 7px;
      border-top: 1px solid #ccc;
      margin-bottom: 10px;
      margin-top: 5px;
    }
    .footer-total {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .totals-container {
      width: 300px;
    }
    .total-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 13px;
    }
    .total-row.grand-total {
      border-top: 1px solid #000;
      padding-top: 8px;
      margin-top: 4px;
      font-size: 14px;
      font-weight: bold;
    }
    .total-label {
      color: #555;
    }
    .total-value {
      color: #000;
      font-weight: 500;
    }
    .grand-total .total-label,
    .grand-total .total-value {
      color: #000;
      font-weight: bold;
    }
    .balance-due {
      margin-top: 15px;
      font-size: 14px;
    }
    .payments {
      margin-top: 10px;
    }
    .payment-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 13px;
    }
    .payment-label {
      color: #555;
    }
    .payment-value {
      color: #000;
      font-weight: 500;
    }
    .note, .disclaimer {
      font-size: 12px;
      color: #555;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div class="header-top">
    <div class="invoice-meta">
        <h1>Invoice</h1>
        <p><strong>Invoice number</strong> {{ invoice_number }}</p>
        <p>Date of issue: {{ date|format_date }}</p>
        <p>Date due: {{ due_date|format_date }}</p>
    </div>

    <div class="company-logo">
        {% if company.logo %}
            <img src="{{ company.logo }}" alt="Company Logo" class="logo">
        {% endif %}
    </div>
</div>

<div class="address-section">
    <div class="company-info">
      <p><strong>{{ company.name }}</strong></p>
      {% if company.address %}<p>{{ company.address }}</p>{% endif %}
      {% if company.city or company.state or company.zip %}
      <p>{{ company.city }}{% if company.city and company.state %}, {% endif %}{{ company.state }} {{ company.zip }}</p>
      {% endif %}
      {% if company.phone %}<p>{{ company.phone }}</p>{% endif %}
      {% if company.email %}<p>{{ company.email }}</p>{% endif %}
    </div>
    <div class="client-insurance-container">
      <div class="client-info">
        <p><strong>Bill to</strong></p>
        <p>{{ client.name }}</p>
        {% if client.address %}<p>{{ client.address }}</p>{% endif %}
        {% if client.city or client.state or client.zip %}
        <p>{{ client.city }}{% if client.city and client.state %}, {% endif %}{{ client.state }} {{ client.zip }}</p>
        {% endif %}
        {% if client.phone %}<p>{{ client.phone }}</p>{% endif %}
        {% if client.email %}<p>{{ client.email }}</p>{% endif %}
      </div>

      {% if insurance and (insurance.insurance_company or insurance.insurance_policy_number or insurance.insurance_claim_number or insurance.insurance_deductible) %}
      <div class="insurance-info">
        <p><strong>Insurance Information</strong></p>
        {% if insurance.insurance_company %}<p>Company: {{ insurance.insurance_company }}</p>{% endif %}
        {% if insurance.insurance_policy_number %}<p>Policy #: {{ insurance.insurance_policy_number }}</p>{% endif %}
        {% if insurance.insurance_claim_number %}<p>Claim #: {{ insurance.insurance_claim_number }}</p>{% endif %}
        {% if insurance.insurance_deductible %}<p>Deductible: ${{ '{:,.2f}'.format(insurance.insurance_deductible) }}</p>{% endif %}
      </div>
      {% elif insurance_company or insurance_policy_number or insurance_claim_number or insurance_deductible %}
      <div class="insurance-info">
        <p><strong>Insurance Information</strong></p>
        {% if insurance_company %}<p>Company: {{ insurance_company }}</p>{% endif %}
        {% if insurance_policy_number %}<p>Policy #: {{ insurance_policy_number }}</p>{% endif %}
        {% if insurance_claim_number %}<p>Claim #: {{ insurance_claim_number }}</p>{% endif %}
        {% if insurance_deductible %}<p>Deductible: ${{ '{:,.2f}'.format(insurance_deductible) }}</p>{% endif %}
      </div>
      {% endif %}
    </div>
</div>

<div class="amount-due">
  <h3>${{ '{:,.2f}'.format(total) }} USD due {{ due_date|format_date }}</h3>
</div>

{% if notes %}
<p>{{ notes }}</p>
{% endif %}

<!-- Check sections first (with subtotals), then fall back to serviceSections -->
{% if sections and sections|length > 0 %}
  <!-- ✅ Using sections with subtotals -->
  {% set item_counter = namespace(value=0) %}
  {% for section in sections %}
    <!-- Always show section title if it's not a default name -->
    {% if section.title and section.title != 'Items' and section.title != 'Services' %}
      <div class="section-title">{{ section.title }}</div>
    {% endif %}

    <div class="line-header">
        <div class="col-item">Item</div>
        <div class="col-qty">Qty</div>
        <div class="col-unit">Unit</div>
        <div class="col-price">Price</div>
        <div class="col-total">Total</div>
    </div>

    {% for item in section['items'] %}
    {% set item_counter.value = item_counter.value + 1 %}
    <div class="line-row">
      <div class="col-item">{{ item_counter.value }}. {{ item.description if item.description else item.name }}</div>
      <div class="col-qty">{{ item.quantity }}</div>
      <div class="col-unit">{% if item.unit %}{{ item.unit }}{% else %}ea{% endif %}</div>
      <div class="col-price">{{ item.rate|format_currency }}</div>
      <div class="col-total">{{ (item.quantity * item.rate)|format_currency }}</div>
    </div>

    {% if item.note %}
      <div class="col-desc">{{ item.note.replace('\n', '<br>') | safe }}</div>
    {% endif %}
    {% endfor %}
    
    <!-- Section Subtotal -->
    {% if section.get('showSubtotal', True) %}
    <div class="subtotal">
      {{ section.title }} Subtotal: {{ section.subtotal|format_currency }}
    </div>
    {% endif %}
  {% endfor %}
{% elif serviceSections %}
  <div class="line-header">
      <div class="col-item">Item</div>
      <div class="col-qty">Qty</div>
      <div class="col-unit">Unit</div>
      <div class="col-price">Price</div>
      <div class="col-total">Total</div>
  </div>

  <!-- Display sections if available, otherwise show flat items list -->
  <!-- DEBUG START -->
  <!-- sections variable exists: {{ 'YES' if sections is defined else 'NO' }} -->
  <!-- sections type: {{ sections.__class__.__name__ if sections is defined else 'undefined' }} -->
  <!-- sections length: {{ sections|length if sections else 0 }} -->
  <!-- sections value: {{ sections }} -->
  <!-- DEBUG END -->
  
  {% if sections and sections|length > 0 %}
    <!-- ✅ USING SECTIONS LAYOUT -->
    {% for section in sections %}
      <!-- Section Header -->
      <div class="line-row" style="background-color: #f5f5f5; font-weight: 600; margin-top: 8px;">
        <div class="col-item">{{ section.title }}</div>
        <div class="col-qty"></div>
        <div class="col-unit"></div>
        <div class="col-price"></div>
        <div class="col-total"></div>
      </div>
      
      <!-- Section Items -->
      {% for item in section['items'] %}
      <div class="line-row">
        <div class="col-item">{{ item.description if item.description else item.name }}</div>
        <div class="col-qty">{{ item.quantity }}</div>
        <div class="col-unit">{% if item.unit %}{{ item.unit }}{% else %}ea{% endif %}</div>
        <div class="col-price">{{ item.rate|format_currency }}</div>
        <div class="col-total">{{ (item.quantity * item.rate)|format_currency }}</div>
      </div>

      {% if item.note %}
        <div class="col-desc">{{ item.note.replace('\n', '<br>') | safe }}</div>
      {% endif %}
      {% endfor %}
      
      <!-- Section Subtotal -->
      <div class="line-row" style="font-weight: 600; border-top: 1px solid #ddd; background-color: #fafafa;">
        <div class="col-item" style="text-align: right; padding-right: 10px;">{{ section.title }} Subtotal</div>
        <div class="col-qty"></div>
        <div class="col-unit"></div>
        <div class="col-price"></div>
        <div class="col-total">{{ section.subtotal|format_currency }}</div>
      </div>
    {% endfor %}
  {% else %}
    <!-- Fallback: flat items list -->
    {% for item in items %}
    <div class="line-row">
      <div class="col-item">{{ item.description if item.description else item.name }}</div>
      <div class="col-qty">{{ item.quantity }}</div>
      <div class="col-unit">{% if item.unit %}{{ item.unit }}{% else %}ea{% endif %}</div>
      <div class="col-price">{{ item.rate|format_currency }}</div>
      <div class="col-total">{{ (item.quantity * item.rate)|format_currency }}</div>
    </div>

    {% if item.note %}
      <div class="col-desc">{{ item.note.replace('\n', '<br>') | safe }}</div>
    {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}

<div class="footer-total">
  <div class="totals-container">
    <div class="total-row">
      <span class="total-label">Items Subtotal</span>
      <span class="total-value">${{ '{:,.2f}'.format(items_subtotal) }}</span>
    </div>

    {% if op_percent and op_percent > 0 %}
    <div class="total-row">
      <span class="total-label">O&P ({{ op_percent }}%)</span>
      <span class="total-value">${{ '{:,.2f}'.format(op_amount) }}</span>
    </div>
    {% endif %}

    {% if tax_amount and tax_amount > 0 %}
    <div class="total-row">
      {% if tax_method == 'percentage' and tax_rate %}
        <span class="total-label">Tax ({{ tax_rate }}%)</span>
      {% else %}
        <span class="total-label">Tax</span>
      {% endif %}
      <span class="total-value">${{ '{:,.2f}'.format(tax_amount) }}</span>
    </div>
    {% endif %}

    {% if discount and discount > 0 %}
    <div class="total-row">
      <span class="total-label">Discount</span>
      <span class="total-value">-${{ '{:,.2f}'.format(discount) }}</span>
    </div>
    {% endif %}

    {% if shipping and shipping > 0 %}
    <div class="total-row">
      <span class="total-label">Shipping</span>
      <span class="total-value">${{ '{:,.2f}'.format(shipping) }}</span>
    </div>
    {% endif %}

    <div class="total-row grand-total">
      <span class="total-label">Total</span>
      <span class="total-value">${{ '{:,.2f}'.format(total) }}</span>
    </div>

    {% if payments and payments|length > 0 %}
      {% for payment in payments %}
      <div class="total-row">
        <span class="total-label">Payment{% if payment.date %} ({{ payment.date|format_date }}){% endif %}</span>
        <span class="total-value">-${{ '{:,.2f}'.format(payment.amount) }}</span>
      </div>
      {% endfor %}

      {% set total_paid = payments | sum(attribute='amount') %}
      <div class="total-row">
        <span class="total-label">Total Paid</span>
        <span class="total-value">${{ '{:,.2f}'.format(total_paid) }}</span>
      </div>

      <div class="total-row grand-total balance-due">
        <span class="total-label">Balance Due</span>
        <span class="total-value">${{ '{:,.2f}'.format(total - total_paid) }}</span>
      </div>
    {% else %}
      <div class="total-row grand-total balance-due">
        <span class="total-label">Amount Due</span>
        <span class="total-value">${{ '{:,.2f}'.format(total) }}</span>
      </div>
    {% endif %}
  </div>
</div>
</div>

{% if payment_terms %}
  <p class="note">{{ payment_terms | safe }}</p>
{% endif %}

</body>
</html>